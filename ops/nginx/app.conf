# FastCGI cache path for server-side caching (DISABLED - commented out to prevent server-side caching)
# fastcgi_cache_path /var/cache/api.fiyge.com levels=1:2 keys_zone=api_uat_cache:10m max_size=10g inactive=60m use_temp_path=off;

server {
    server_name api.fiyge.com; # Replace with your Linode IP if no domain is configured
    root /var/www/api.fiyge.com/client/webroot;
    index index.php index.html index.htm;

    # Enable ETags for better client-side caching validation
    etag on;

    # Gzip compression settings
    gzip on;
    gzip_vary on; # Adds Vary: Accept-Encoding header
    gzip_min_length 256; # Minimum response size to compress
    gzip_comp_level 6; # Balanced compression level (1-9)
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        application/xml
        application/xhtml+xml
        image/svg+xml
        font/ttf
        font/opentype
        font/x-woff
        font/x-woff2;

    # Prefix location for /development_base/ - handles static files or rewrites to index.php
    location /development_base/ {
        try_files $uri $uri/ /index.php?is_metadata=1&$query_string;
    }

    # Prefix location for /core/ - handles static files or rewrites to index.php
    location /core/ {
        try_files $uri $uri/ /index.php?is_metadata=1&$query_string;
    }

    location /metadata/ {
        try_files $uri $uri/ /index.php?is_metadata=1&$query_string;
    }

    # Default location for all other paths - handles static files or rewrites to index.php
    location / {
        add_header Vary "Accept-Encoding";
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Location for static assets - long-term client caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
        try_files $uri =404; # Serve directly, return 404 if not found
    }

    # Default PHP handler - client-side caching only (server-side caching disabled)
    location ~ \.php$ {
        # Client-side cache headers
        add_header Vary "Accept-Encoding";
        # add_header Cache-Control "public, max-age=90" always;

        set $cache_control "no-cache";
        if ($args ~* "is_metadata=1") {
            set $cache_control "public, max-age=1800";
        }
        add_header Cache-Control $cache_control always;

        # FastCGI parameters and pass to PHP-FPM
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
        fastcgi_pass_header ETag;
        fastcgi_pass_header Last-Modified;
    }

    # Deny access to .ht files (e.g., .htaccess)
    location ~ /\.ht {
        deny all;
    }

    # SSL configuration (managed by Certbot)
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/api.fiyge.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.fiyge.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP to HTTPS redirect server (managed by Certbot)
server {
    if ($host = api.fiyge.com) {
        return 301 https://$host$request_uri;
    }

    server_name api.fiyge.com;
    listen 80;
    return 404;
}
